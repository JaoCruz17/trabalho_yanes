<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script defer src="/firebase.js"></script>
</head>
<body class="bg-gray-50 min-h-screen flex">

  <!-- Sidebar -->
  <aside class="w-64 bg-white shadow-md p-6">
    <h2 class="text-xl font-bold mb-8">Gestor de Produtos</h2>
    <nav class="space-y-2">
      <a href="dashboard.html" class="block text-blue-600 font-semibold">Dashboard</a>
      <a href="produtos.html" class="block text-gray-600 hover:text-blue-600">Produtos</a>
      <a href="usuarios.html" class="block text-gray-600 hover:text-blue-600">Usu√°rios</a>
      <button id="logoutBtn" class="mt-8 text-red-500 hover:text-red-700">Sair</button>
    </nav>
  </aside>

  <!-- Conte√∫do principal -->
  <main class="flex-1 p-8">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-semibold">Dashboard</h1>
      
      <!-- Filtros R√°pidos -->
      <div class="flex gap-4 items-center">
        <input type="text" id="buscaRapida" placeholder="Buscar por SKU..." 
               class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
        <button id="exportarRelatorio" class="bg-green-600 hover:bg-green-700 text-white rounded-xl px-4 py-2">
          Exportar Relat√≥rio
        </button>
      </div>
    </div>

    <!-- Filtros Avan√ßados -->
    <div class="bg-white p-4 rounded-xl shadow mb-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
          <select id="filtroCategoria" class="w-full border border-gray-300 rounded-lg px-3 py-2">
            <option value="">Todas as categorias</option>
            <option value="Eletr√¥nicos">Eletr√¥nicos</option>
            <option value="M√≥veis">M√≥veis</option>
            <option value="Limpeza">Limpeza</option>
            <option value="Higiene">Higiene</option>
            <option value="Alimento">Alimento</option>
            <option value="Bebidas">Bebidas</option>
            <option value="Congelados">Congelados</option>
            <option value="Sa√∫de">Sa√∫de</option>
            <option value="Utilidades">Utilidades</option>
            <option value="Infantil">Infantil</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Status Estoque</label>
          <select id="filtroStatus" class="w-full border border-gray-300 rounded-lg px-3 py-2">
            <option value="">Todos</option>
            <option value="normal">Estoque Normal</option>
            <option value="baixo">Estoque Baixo</option>
            <option value="zerado">Estoque Zerado</option>
            <option value="vencimento">Pr√≥ximo do Vencimento</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Faixa de Pre√ßo</label>
          <select id="filtroPreco" class="w-full border border-gray-300 rounded-lg px-3 py-2">
            <option value="">Todas</option>
            <option value="0-50">At√© R$ 50</option>
            <option value="50-100">R$ 50 - R$ 100</option>
            <option value="100-500">R$ 100 - R$ 500</option>
            <option value="500+">Acima de R$ 500</option>
          </select>
        </div>
        <div class="flex items-end">
          <button id="aplicarFiltros" class="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-4 py-2 w-full">
            Aplicar Filtros
          </button>
        </div>
      </div>
    </div>

    <!-- Cards Principais -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
      <div class="p-4 bg-white rounded-xl shadow text-center transform transition-transform duration-300 hover:scale-105">
        <div class="text-2xl mb-2">üì¶</div>
        <p class="text-gray-500 text-sm">Total de Produtos</p>
        <h3 id="totalProdutos" class="text-2xl font-bold">0</h3>
      </div>
      <div class="p-4 bg-white rounded-xl shadow text-center transform transition-transform duration-300 hover:scale-105">
        <div class="text-2xl mb-2">üí∞</div>
        <p class="text-gray-500 text-sm">Valor Total em Estoque</p>
        <h3 id="valorTotal" class="text-2xl font-bold text-green-600">R$ 0,00</h3>
      </div>
      <div class="p-4 bg-white rounded-xl shadow text-center transform transition-transform duration-300 hover:scale-105">
        <div class="text-2xl mb-2">üìä</div>
        <p class="text-gray-500 text-sm">Vendas do M√™s</p>
        <h3 id="vendasMes" class="text-2xl font-bold text-blue-600">R$ 0,00</h3>
      </div>
      <div class="p-4 bg-white rounded-xl shadow text-center transform transition-transform duration-300 hover:scale-105">
        <div class="text-2xl mb-2">‚ö†Ô∏è</div>
        <p class="text-gray-500 text-sm">Pr√≥ximos do Vencimento</p>
        <h3 id="proximosVencimento" class="text-2xl font-bold text-yellow-600">0</h3>
      </div>
    </div>

    <!-- Notifica√ß√µes -->
    <div id="notificacoes" class="mb-6 space-y-2">
      <!-- Notifica√ß√µes ser√£o inseridas aqui dinamicamente -->
    </div>

    <!-- Gr√°ficos e Se√ß√µes -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- Gr√°fico de Barras - Valor por Categoria -->
      <div class="bg-white p-6 rounded-xl shadow">
        <h3 class="text-lg font-semibold mb-4">Valor Total por Categoria</h3>
        <canvas id="graficoCategorias" height="250"></canvas>
      </div>

      <!-- Top 5 Produtos Mais Valiosos -->
      <div class="bg-white p-6 rounded-xl shadow">
        <h3 class="text-lg font-semibold mb-4">Top 5 Produtos Mais Valiosos</h3>
        <div id="topProdutos" class="space-y-3">
          <!-- Produtos ser√£o inseridos aqui -->
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- √öltimos Produtos Cadastrados -->
      <div class="bg-white p-6 rounded-xl shadow">
        <h3 class="text-lg font-semibold mb-4">√öltimos Produtos Cadastrados</h3>
        <div id="ultimosProdutos" class="space-y-3">
          <!-- Produtos ser√£o inseridos aqui -->
        </div>
      </div>

      <!-- Produtos Pr√≥ximos do Vencimento -->
      <div class="bg-white p-6 rounded-xl shadow">
        <h3 class="text-lg font-semibold mb-4">Produtos Pr√≥ximos do Vencimento</h3>
        <div id="produtosVencimento" class="space-y-3">
          <!-- Produtos ser√£o inseridos aqui -->
        </div>
      </div>
    </div>

    <!-- Movimenta√ß√µes Recentes -->
    <div class="bg-white p-6 rounded-xl shadow">
      <h3 class="text-lg font-semibold mb-4">Movimenta√ß√µes Recentes de Estoque</h3>
      <div id="movimentacoes" class="space-y-3">
        <!-- Movimenta√ß√µes ser√£o inseridas aqui -->
      </div>
    </div>
  </main>

  <script type="module">
    import { auth, db } from "./firebase.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { collection, getDocs, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const logoutBtn = document.getElementById("logoutBtn");
    logoutBtn.addEventListener("click", () => signOut(auth).then(() => (window.location = "index.html")));

    let produtos = [];
    let graficoCategorias;

    onAuthStateChanged(auth, async (user) => {
      if (!user) return (window.location = "index.html");

      await carregarDados();
      inicializarFiltros();
    });

    async function carregarDados() {
      const produtosRef = collection(db, "produtos");
      const snapshot = await getDocs(produtosRef);

      produtos = [];
      snapshot.forEach((doc) => {
        produtos.push({
          id: doc.id,
          ...doc.data()
        });
      });

      atualizarDashboard();
    }

    function atualizarDashboard() {
      atualizarCards();
      atualizarNotificacoes();
      atualizarGraficoCategorias();
      atualizarTopProdutos();
      atualizarUltimosProdutos();
      atualizarProdutosVencimento();
      atualizarMovimentacoes();
    }

    function atualizarCards() {
      let total = 0, valor = 0, baixo = 0, sem = 0, vencimento = 0;
      const hoje = new Date();
      
      produtos.forEach((p) => {
        total++;
        valor += p.preco * p.estoque;
        if (p.estoque === 0) sem++;
        if (p.estoque > 0 && p.estoque <= 5) baixo++;
        
        // Verificar produtos pr√≥ximos do vencimento (30 dias)
        if (p.dataVencimento) {
          const dataVenc = new Date(p.dataVencimento);
          const diffTime = dataVenc - hoje;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          if (diffDays <= 30 && diffDays > 0) {
            vencimento++;
          }
        }
      });

      // Animar os cards
      animarValor('totalProdutos', total);
      animarValor('valorTotal', `R$ ${valor.toFixed(2)}`);
      animarValor('vendasMes', `R$ ${(valor * 0.15).toFixed(2)}`); // Simula√ß√£o de vendas
      animarValor('proximosVencimento', vencimento);
    }

    function animarValor(elementId, valorFinal) {
      const element = document.getElementById(elementId);
      element.style.opacity = '0';
      setTimeout(() => {
        element.textContent = valorFinal;
        element.style.opacity = '1';
        element.classList.add('animate-pulse');
        setTimeout(() => element.classList.remove('animate-pulse'), 1000);
      }, 300);
    }

    function atualizarNotificacoes() {
      const notificacoes = document.getElementById('notificacoes');
      notificacoes.innerHTML = '';

      produtos.forEach(produto => {
        if (produto.estoque === 0) {
          adicionarNotificacao(`‚ùå Estoque zerado: ${produto.nome}`, 'bg-red-100 border-red-400 text-red-700');
        } else if (produto.estoque <= 5) {
          adicionarNotificacao(`‚ö†Ô∏è Estoque baixo: ${produto.nome} - ${produto.estoque} unidades`, 'bg-yellow-100 border-yellow-400 text-yellow-700');
        }

        if (produto.dataVencimento) {
          const hoje = new Date();
          const dataVenc = new Date(produto.dataVencimento);
          const diffDays = Math.ceil((dataVenc - hoje) / (1000 * 60 * 60 * 24));
          
          if (diffDays <= 7 && diffDays > 0) {
            adicionarNotificacao(`üö® ${produto.nome} vence em ${diffDays} dias`, 'bg-red-100 border-red-400 text-red-700');
          } else if (diffDays <= 30 && diffDays > 0) {
            adicionarNotificacao(`üìÖ ${produto.nome} vence em ${diffDays} dias`, 'bg-yellow-100 border-yellow-400 text-yellow-700');
          }
        }
      });
    }

    function adicionarNotificacao(mensagem, classes) {
      const notificacoes = document.getElementById('notificacoes');
      const div = document.createElement('div');
      div.className = `p-3 rounded-lg border ${classes} animate-fade-in`;
      div.textContent = mensagem;
      notificacoes.appendChild(div);
    }

    function atualizarGraficoCategorias() {
      const ctx = document.getElementById('graficoCategorias').getContext('2d');
      
      // Agrupar por categoria
      const categorias = {};
      produtos.forEach(produto => {
        if (!categorias[produto.categoria]) {
          categorias[produto.categoria] = 0;
        }
        categorias[produto.categoria] += produto.preco * produto.estoque;
      });

      // Destruir gr√°fico anterior se existir
      if (graficoCategorias) {
        graficoCategorias.destroy();
      }

      graficoCategorias = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(categorias),
          datasets: [{
            label: 'Valor em Estoque (R$)',
            data: Object.values(categorias),
            backgroundColor: [
              '#3B82F6', '#10B981', '#EF4444', '#F59E0B', '#8B5CF6',
              '#06B6D4', '#84CC16', '#F97316', '#EC4899', '#6366F1'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'R$ ' + value.toLocaleString('pt-BR');
                }
              }
            }
          }
        }
      });
    }

    function atualizarTopProdutos() {
      const topProdutos = document.getElementById('topProdutos');
      topProdutos.innerHTML = '';

      // Ordenar por valor total (pre√ßo * estoque)
      const produtosOrdenados = [...produtos]
        .filter(p => p.estoque > 0)
        .sort((a, b) => (b.preco * b.estoque) - (a.preco * a.estoque))
        .slice(0, 5);

      produtosOrdenados.forEach((produto, index) => {
        const valorTotal = produto.preco * produto.estoque;
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
        div.innerHTML = `
          <div class="flex items-center">
            <span class="bg-blue-100 text-blue-800 text-sm font-bold px-2 py-1 rounded mr-3">${index + 1}</span>
            <div>
              <div class="font-medium">${produto.nome}</div>
              <div class="text-sm text-gray-500">${produto.categoria}</div>
            </div>
          </div>
          <div class="text-right">
            <div class="font-bold text-green-600">R$ ${valorTotal.toFixed(2)}</div>
            <div class="text-sm text-gray-500">${produto.estoque} unidades</div>
          </div>
        `;
        topProdutos.appendChild(div);
      });
    }

    function atualizarUltimosProdutos() {
      const ultimosProdutos = document.getElementById('ultimosProdutos');
      ultimosProdutos.innerHTML = '';

      // Ordenar por data de cadastro (mais recentes primeiro)
      const produtosRecentes = [...produtos]
        .sort((a, b) => new Date(b.dataCadastro || 0) - new Date(a.dataCadastro || 0))
        .slice(0, 5);

      produtosRecentes.forEach(produto => {
        const dataCadastro = produto.dataCadastro ? new Date(produto.dataCadastro).toLocaleDateString('pt-BR') : 'N/A';
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
        div.innerHTML = `
          <div>
            <div class="font-medium">${produto.nome}</div>
            <div class="text-sm text-gray-500">${produto.categoria} ‚Ä¢ SKU: ${produto.sku}</div>
          </div>
          <div class="text-sm text-gray-500">${dataCadastro}</div>
        `;
        ultimosProdutos.appendChild(div);
      });
    }

    function atualizarProdutosVencimento() {
      const produtosVencimento = document.getElementById('produtosVencimento');
      produtosVencimento.innerHTML = '';

      const hoje = new Date();
      const produtosProximos = produtos.filter(produto => {
        if (!produto.dataVencimento) return false;
        const dataVenc = new Date(produto.dataVencimento);
        const diffDays = Math.ceil((dataVenc - hoje) / (1000 * 60 * 60 * 24));
        return diffDays <= 30 && diffDays > 0;
      }).sort((a, b) => new Date(a.dataVencimento) - new Date(b.dataVencimento));

      if (produtosProximos.length === 0) {
        produtosVencimento.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum produto pr√≥ximo do vencimento</p>';
        return;
      }

      produtosProximos.forEach(produto => {
        const dataVenc = new Date(produto.dataVencimento);
        const diffDays = Math.ceil((dataVenc - hoje) / (1000 * 60 * 60 * 24));
        const corClasse = diffDays <= 7 ? 'text-red-600' : 'text-yellow-600';
        
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
        div.innerHTML = `
          <div>
            <div class="font-medium">${produto.nome}</div>
            <div class="text-sm text-gray-500">${produto.categoria}</div>
          </div>
          <div class="text-right ${corClasse}">
            <div class="font-bold">${diffDays} dias</div>
            <div class="text-sm">${dataVenc.toLocaleDateString('pt-BR')}</div>
          </div>
        `;
        produtosVencimento.appendChild(div);
      });
    }

    function atualizarMovimentacoes() {
      const movimentacoes = document.getElementById('movimentacoes');
      movimentacoes.innerHTML = '';

      // Simular movimenta√ß√µes (em um sistema real, isso viria do Firestore)
      const movimentacoesSimuladas = [
        { tipo: 'entrada', produto: 'Arroz', quantidade: 100, data: new Date(), usuario: 'Sistema' },
        { tipo: 'saida', produto: 'Feij√£o', quantidade: 50, data: new Date(), usuario: 'Venda' },
        { tipo: 'ajuste', produto: 'A√ß√∫car', quantidade: -10, data: new Date(), usuario: 'Invent√°rio' }
      ];

      movimentacoesSimuladas.forEach(mov => {
        const icone = mov.tipo === 'entrada' ? '‚¨ÜÔ∏è' : mov.tipo === 'saida' ? '‚¨áÔ∏è' : 'üîÑ';
        const cor = mov.tipo === 'entrada' ? 'text-green-600' : mov.tipo === 'saida' ? 'text-red-600' : 'text-blue-600';
        
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
        div.innerHTML = `
          <div class="flex items-center">
            <span class="text-lg mr-3">${icone}</span>
            <div>
              <div class="font-medium">${mov.produto}</div>
              <div class="text-sm text-gray-500">${mov.usuario}</div>
            </div>
          </div>
          <div class="text-right">
            <div class="font-bold ${cor}">${mov.quantidade > 0 ? '+' : ''}${mov.quantidade} unidades</div>
            <div class="text-sm text-gray-500">${mov.data.toLocaleDateString('pt-BR')}</div>
          </div>
        `;
        movimentacoes.appendChild(div);
      });
    }

    function inicializarFiltros() {
      document.getElementById('aplicarFiltros').addEventListener('click', aplicarFiltros);
      document.getElementById('buscaRapida').addEventListener('input', buscarPorSKU);
      document.getElementById('exportarRelatorio').addEventListener('click', exportarRelatorio);
    }

    function aplicarFiltros() {
      // Implementar l√≥gica de filtros
      console.log('Filtros aplicados');
    }

    function buscarPorSKU() {
      const sku = document.getElementById('buscaRapida').value.toLowerCase();
      if (sku.length >= 2) {
        const produtoEncontrado = produtos.find(p => p.sku.toLowerCase().includes(sku));
        if (produtoEncontrado) {
          alert(`Produto encontrado: ${produtoEncontrado.nome} - Estoque: ${produtoEncontrado.estoque}`);
        }
      }
    }

    function exportarRelatorio() {
      // Simular exporta√ß√£o
      alert('Relat√≥rio exportado com sucesso!');
    }

    // Adicionar CSS para anima√ß√µes
    const style = document.createElement('style');
    style.textContent = `
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .animate-fade-in {
        animation: fadeIn 0.5s ease-out;
      }
    `;
    document.head.appendChild(style);
  </script>
</body>

<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-fade-in {
    animation: fadeIn 0.5s ease-out;
  }
  
  .card-hover {
    transition: all 0.3s ease;
  }
  .card-hover:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  }
</style>
</html>